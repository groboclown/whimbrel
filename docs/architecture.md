# Data Flow and Architecture


## DynamoDB Tables

The user may change the table prefix, but the default is `whimbrel_`.
This document refers to the default prefix.

### Notes on date formats

All dates are in UTC time.  The "epoch" refers to the Unix
epoch 1970-01-01 00:00:00 UTC.  The list format uses 4-digit years,
and day-of-month and month numbers, each being base 1 (Jan 2 = 1,2)

An example of creating the epoch and date list using shell scripts:

```
$ date_epoch=`date -u +%s`
$ date_list=`date --date="@$date_epoch" +"[%Y,%-m,%-d,%-H,%-M,%-S]"`
```


### `whimbrel_install_status`

General information about each metadata item (lambdas, tables, etc)
and their install status.  Used for upgrading.

* `whimbrel_install_status`
    * Primary key type: Hash Range
        * Hash attribute name: `object_id` (String)
        * Range attribute name: `object_type` (String)
    * Additional attributes:
        * `version` (Number)
        * `description` (String)


### `whimbrel_workflow_request`

Records the requests to initiate workflow.  If the Simple Lambda API is
being used, inserts into this table trigger Lambda scripts to initiate a
workflow.  This table is only explicitly required for the Simple Lambda API
is enabled, but it is also useful for record keeping.

This table uses a write-once model (no updates).

* `whimbrel_workflow_request`
    * Primary key type: Hash Range
        * Hash attribute name: `workflow_request_id` (String)
            A UUID generated by the client.  Should be in the
            form `(workflow_name)::(uuid)`
        * Range attribute name: `workflow_name` (String, local index)
            Actual workflow executed.
    * Additional attributes:
        * `when` (list)
           Defines when the request was made.  Format is:
           `[ year, month (Jan = 1), day (1 = 1), 24-hour, minute, second ]`
           with each value being a Number.  `second` can be a float, everything
           else must be an integer.  As this is sent by the client, it should
           be in UTC.
        * `when_epoc` (Number)
           Unix epoch time, UTC.
        * `source` (String)
           A description about where the request came from.
        * `manual` (Boolean)
           This should only be set to True if the
           Logic API is used; Simple Lambda API should not even set this
           attribute.


### `whimbrel_activity_event`

Records changes to activity state.  If the Simple Lambda API is
being used, inserts into this table trigger Lambda scripts to process the logic
required for the activity change.  This table is only explicitly required for
the Simple Lambda API is enabled, but it is also useful for record keeping.

This table uses a write-once model (no updates).

* `whimbrel_activity_event`
    * Primary key:
        * Hash attribute name: `activity_event_id` (String)
            A UUID generated by the client.
        * Range attribute name: `activity_exec_id` (String, local index)
            The activity execution which generated this event.
    * Additional attributes:
        * `when` (list)
           Defines when the request was made.  Format is:
           `[ year, month (Jan = 1), day (1 = 1), 24-hour, minute, second ]`
           with each value being a Number.  `second` can be a float, everything
           else must be an integer.  As this is sent by the client, it should
           be in UTC.
        * `source` (String)
           A description about where the request came from.
        * `manual` (Boolean)
           This should only be set to True if the
           Logic API is used; Simple Lambda API should not even set this
           attribute.
        * `transition` (String)
          The requested activity transition, to change it to a new state.


### `whimbrel_workflow_exec`

Lists the execution state of workflow.

* `whimbrel_workflow_exec`
    * Primary key:
        * Hash attribute name: `workflow_exec_id` (String)
            A UUID generated by the client.  Should be in the
            form `(workflow_name)::(uuid)`
        * Range attribute name: `workflow_request_id` (String, local index)
            The requested workflow ID.  Could be empty ("") if the
            request table isn't used, but can't be null.
    * Secondary Indicies:
        * `state` (String, local index)
            Workflow state.
        * `start_time_epoch` (Number, local index)
            Unix epoch time, UTC.
    * Additional attributes:
        * `workflow_name` (String, local index)
        * `start_time` (list)
           Defines when the workflow was queued.  Format is:
           `[ year, month (Jan = 1), day (1 = 1), 24-hour, minute, second ]`
           with each value being a Number.  `second` can be a float, everything
           else must be an integer.  As this is sent by the client, it should
           be in UTC.


### `whimbrel_activity_exec`

Lists the execution state of the activities.

* `whimbrel_activity_exec`
    * Primary key:
        * Hash attribute name: `activity_exec_id` (String)
            A UUID generated by the client.  Should be in the
            form `(activity_name)::(uuid)`
        * `workflow_exec_id` (String, local)
            Workflow exec.
    * Secondary Indicies:
        * `state` (String, local)
            Activity state
        * `start_time_epoch` (Number, local index)
            Unix epoch time, UTC.
        * `heartbeat_time_epoch` (Number, local index)
            Unix epoch time, UTC.  Negative number means that
            heartbeat is not enabled.
    * Additional attributes:
        * `workflow_name` (String, local)
        * `activity_name` (String, local)
        * `heartbeat_enabled` (Boolean)
            True if the heartbeats are supported for this activity.
        * `queued_time` (list)
            Defines the time when the activity was scheduled to run.
        * `queued_time_epoc` (Number)
            Defines the time when the activity was scheduled to run.
        * `start_time` (list)
            Defines the time when the activity actually started running.
        * `end_time` (list)
            Defines the time when the activity completed running.
        * `end_time_epoc` (Number)
            Defines the time when the activity completed running.
        * Additional information about the execution environment.


### `whimbrel_activity_exec_dependency`

This table uses a write-once model (no updates).

* `whimbrel_activity_exec_dependency`
    * Primary key:
        * `activity_exec_dependency` (String)
            A concatenation of the `activity_exec_id`, ':', and the dependency index.
        * `activity_exec_id` (String)
            The activity execution whose dependency this item describes.
     * Secondary Indicies:
        * `workflow_exec_id` (String)
        * `dependent_activity_exec_id` (String)



## Workflow Jobs

Whimbrel has a set of "jobs" that it expects to run.  These perform simple maintenance,
or add additional functionality that the workflow implementation might rely upon, or
be part of the standard execution model.


### Workflow Launcher



### Activity Launcher



### Heartbeat Monitor

One of the trickiest parts of a distributed system is detecting and dealing with
partial failures.  This can happen when the remote system loses network connectivity,
or crashes without notification.

For activities that support heartbeat (the `heartbeat_enabled` is True), the
`heartbeat_epoch` is updated at intervals.  If this column isn't updated within a
time period, the activity is considered to be dead, and is put into a `TIMED_OUT`
state.

The Hearbeat Monitor is the job that handles this logic.  It should periodically
run, and perform a conditional update on `whimbrel_activity_exec` where
`state` == `RUNNING` and `heartbeat_enabled` == `TRUE` and
`heartbeat_time_epoch` < (now - timeout period), to set the `state` to `TIMED_OUT`.

